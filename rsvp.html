<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RSVP | Our Wedding</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
</head>

<body>

<header class="site-header">
  <nav class="nav">
    <a class="brand" href="index.html">A & B</a>
    <div class="nav-links">
      <a href="details.html">Details</a>
      <a href="faq.html">FAQ</a>
      <a class="button" href="rsvp.html">RSVP</a>
    </div>
  </nav>
</header>

<main class="container">

  <section class="hero">
    <p class="kicker">Private RSVP</p>
    <h1>Enter your invitation code</h1>
    <p class="subhead">
      Your code is printed on your physical invitation.
    </p>

    <div style="margin-top:20px;">
      <input 
        id="inviteCode"
        type="text"
        placeholder="Example: OAK-1847"
        style="
          padding:10px;
          border-radius:10px;
          border:1px solid #ccc;
          font-size:16px;
          width:220px;
          margin-right:10px;
        "
      />

      <button class="button" onclick="checkCode()">
        Continue
      </button>
    </div>

    <p id="error" style="color:#a05a2c; margin-top:10px;"></p>

  </section>

  <section id="rsvpForm" class="card" style="display:none;">
    <h2>RSVP Form</h2>

    <label>
      Will you attend?
      <br><br>
      <select>
        <option>Yes, with joy</option>
        <option>Regretfully decline</option>
      </select>
    </label>

    <br><br>

    <label>
      Message for the couple:
      <br><br>
      <textarea rows="4" cols="40"></textarea>
    </label>

    <br><br>

    <button class="button">
      Submit RSVP
    </button>

  </section>

</main>

<footer class="site-footer">
  <p>Every reply helps the forest prepare ðŸŒ¿</p>
</footer>

<script>
let parties = {};

// Load parties registry
fetch("data/parties.json")
  .then(r => r.json())
  .then(data => { parties = data; });

function checkCode() {
  const input = document.getElementById("inviteCode").value.toUpperCase().trim();
  const party = parties[input];

  if (!party) {
    document.getElementById("error").textContent = "This invitation code was not found.";
    document.getElementById("rsvpForm").style.display = "none";
    return;
  }

  document.getElementById("error").textContent = "";

  const namedGuests = Array.isArray(party.guests) ? party.guests : [];
  const allowed = Number.isFinite(party.allowedGuests) ? party.allowedGuests : namedGuests.length;
  const extraSeats = Math.max(0, allowed - namedGuests.length);

  const blocks = [];

  // Named guests
  namedGuests.forEach((guestName, idx) => {
    blocks.push(`
      <div class="rsvp-block">
        <label for="attend_named_${idx}" class="rsvp-label">Will ${guestName} attend?</label>
        <select id="attend_named_${idx}" name="attend_named_${idx}">
          <option value="yes">Yes, with joy</option>
          <option value="no">Regretfully decline</option>
        </select>
      </div>
    `);
  });

  // Plus-one slots (only if extra seats exist)
  for (let i = 1; i <= extraSeats; i++) {
    const label = extraSeats === 1 ? "Plus One" : `Plus One ${i}`;

    blocks.push(`
      <div class="rsvp-block">

        <label for="plusone_name_${i}" class="rsvp-label">
          ${label}'s name (optional):
        </label>

        <input
          id="plusone_name_${i}"
          name="plusone_name_${i}"
          type="text"
          placeholder="Name"
          oninput="updatePlusOneLabel(${i}, '${label}')"
        />

        <div style="height:12px;"></div>

        <label
          id="attend_label_plusone_${i}"
          for="attend_plusone_${i}"
          class="rsvp-label"
        >
          Will ${label} attend?
        </label>

        <select id="attend_plusone_${i}" name="attend_plusone_${i}">
          <option value="yes">Yes, with joy</option>
          <option value="no">Regretfully decline</option>
        </select>

        <p class="fineprint" style="margin:10px 0 0;">
          Leave blank if you are not bringing a guest.
        </p>

      </div>
    `);
  }

  // Render the form (includes ids for dietary + message so submitRsvp can read them)
  document.getElementById("rsvpForm").innerHTML = `
    <h2>Welcome, ${party.displayName || "Guests"}</h2>
    <p class="fineprint">Please confirm attendance for each guest on this invitation.</p>

    ${blocks.join("")}

    <label class="rsvp-label">
      Dietary notes (optional):
      <br><br>
      <textarea id="dietary" rows="3" cols="40" placeholder="Allergies, vegetarian, etc."></textarea>
    </label>

    <br><br>

    <label class="rsvp-label">
      Message for the couple (optional):
      <br><br>
      <textarea id="message" rows="4" cols="40" placeholder="A note from the heartâ€¦"></textarea>
    </label>

    <br><br>

    <p id="saveStatus" class="fineprint"></p>
    <button class="button" type="button" id="submitBtn">Submit RSVP</button>
  `;

  document.getElementById("rsvpForm").style.display = "block";
  document.getElementById("submitBtn").onclick = () => submitRsvp(input, party);
}

function updatePlusOneLabel(index, defaultLabel) {
  const input = document.getElementById(`plusone_name_${index}`);
  const label = document.getElementById(`attend_label_plusone_${index}`);

  if (!input || !label) return;

  const name = input.value.trim();

  if (name.length > 0) {
    label.textContent = `Will ${name} attend?`;
  } else {
    label.textContent = `Will ${defaultLabel} attend?`;
  }
}

async function submitRsvp(code, party) {
  const payload = {
    code: code,
    name: party.displayName || "Guests",
    attending: "",
    dietary: document.getElementById("dietary")?.value?.trim() || "",
    message: document.getElementById("message")?.value?.trim() || ""
  };

  // Build a readable attendance summary
  const lines = [];

  // Named guests
  (party.guests || []).forEach((guestName, idx) => {
    const val = document.getElementById(`attend_named_${idx}`)?.value || "";
    lines.push(`${guestName}: ${val}`);
  });

  // Plus-ones
  const namedCount = (party.guests || []).length;
  const allowed = Number.isFinite(party.allowedGuests) ? party.allowedGuests : namedCount;
  const extraSeats = Math.max(0, allowed - namedCount);

  for (let i = 1; i <= extraSeats; i++) {
    const plusName = document.getElementById(`plusone_name_${i}`)?.value?.trim();
    const val = document.getElementById(`attend_plusone_${i}`)?.value || "";

    // Only record plus-one if a name was entered
    if (plusName) {
      lines.push(`${plusName}: ${val}`);
    }
  }

  payload.attending = lines.join(" | ");

  const status = document.getElementById("saveStatus");
  const btn = document.getElementById("submitBtn");

  try {
    if (status) status.textContent = "Savingâ€¦";
    if (btn) btn.disabled = true;

    const res = await fetch("https://wedding-backend-fbbx.onrender.com/rsvp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok || !data.success) {
      throw new Error(data.error || "Save failed");
    }

    if (status) status.textContent = "Saved! Thank you ðŸŒ¿";
    // Optional: prevent double submissions after success
    // if (btn) btn.disabled = true;
  } catch (err) {
    console.error(err);
    if (status) status.textContent = "Could not save RSVP. Is the server running?";
    if (btn) btn.disabled = false; // allow retry
  } finally {
    // If you uncomment the "prevent double submissions" line above,
    // you may want to keep it disabled here.
    if (btn && status?.textContent !== "Saved! Thank you ðŸŒ¿") btn.disabled = false;
  }
}
</script>


</body>
</html>
