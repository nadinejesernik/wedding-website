<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RSVP | Our Wedding</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
</head>

<body>

<header class="site-header">
  <nav class="nav">
    <a class="brand" href="index.html">A & B</a>
    <div class="nav-links">
      <a href="details.html">Details</a>
      <a href="faq.html">FAQ</a>
      <a class="button" href="rsvp.html">RSVP</a>
    </div>
  </nav>
</header>

<main class="container">

  <section class="hero">
    <p class="kicker">Private RSVP</p>
    <h1>Enter your invitation code</h1>
    <p class="subhead">
      Your code is printed on your physical invitation.
    </p>

    <div style="margin-top:20px;">
      <input 
        id="inviteCode"
        type="text"
        placeholder="Example: OAK-1847"
        style="
          padding:10px;
          border-radius:10px;
          border:1px solid #ccc;
          font-size:16px;
          width:220px;
          margin-right:10px;
        "
      />

      <button class="button" onclick="checkCode()">
        Continue
      </button>
    </div>

    <p id="error" style="color:#a05a2c; margin-top:10px;"></p>

  </section>

  <section id="rsvpForm" class="card" style="display:none;">
    <h2>RSVP Form</h2>

    <label>
      Will you attend?
      <br><br>
      <select>
        <option>Yes, with joy</option>
        <option>Regretfully decline</option>
      </select>
    </label>

    <br><br>

    <label>
      Message for the couple:
      <br><br>
      <textarea rows="4" cols="40"></textarea>
    </label>

    <br><br>

    <button class="button">
      Submit RSVP
    </button>

  </section>

</main>

<footer class="site-footer">
  <p>Every reply helps the forest prepare ðŸŒ¿</p>
</footer>

<script>
let parties = {};

fetch("data/parties.json")
  .then(r => r.json())
  .then(data => { parties = data; });

function checkCode() {

  const input = document.getElementById("inviteCode").value.toUpperCase().trim();
  const party = parties[input];

  if (!party) {
    document.getElementById("error").textContent =
      "This invitation code was not found.";
    document.getElementById("rsvpForm").style.display = "none";
    return;
  }

  document.getElementById("error").textContent = "";

  const namedGuests = party.guests || [];
  const allowed = party.allowedGuests || namedGuests.length;
  const extraSeats = Math.max(0, allowed - namedGuests.length);

  const blocks = [];

  namedGuests.forEach((guestName, idx) => {

    blocks.push(`
      <div class="rsvp-block">
        <label class="rsvp-label">
          Will ${guestName} attend?
        </label>

        <select id="attend_named_${idx}">
          <option value="yes">Yes, with joy</option>
          <option value="no">Regretfully decline</option>
        </select>
      </div>
    `);

  });

  for (let i = 1; i <= extraSeats; i++) {

    const label = extraSeats === 1 ? "Plus One" : `Plus One ${i}`;

    blocks.push(`
      <div class="rsvp-block">

        <label class="rsvp-label">
          ${label}'s name (optional):
        </label>

        <input
          id="plusone_name_${i}"
          placeholder="Name"
          oninput="updatePlusOneLabel(${i}, '${label}')"
        >

        <label
          id="attend_label_plusone_${i}"
          class="rsvp-label"
        >
          Will ${label} attend?
        </label>

        <select id="attend_plusone_${i}">
          <option value="yes">Yes, with joy</option>
          <option value="no">Regretfully decline</option>
        </select>

      </div>
    `);

  }

  document.getElementById("rsvpForm").innerHTML = `

    <h2>Welcome, ${party.displayName}</h2>

    ${blocks.join("")}

    <label class="rsvp-label">
      Dietary notes (optional):
    </label>

    <textarea id="dietary"></textarea>

    <label class="rsvp-label">
      Message for the couple (optional):
    </label>

    <textarea id="message"></textarea>

    <p id="saveStatus" class="fineprint"></p>

    <button id="submitBtn" class="button">
      Submit RSVP
    </button>

  `;

  document.getElementById("rsvpForm").style.display = "block";

  document.getElementById("submitBtn").onclick =
    () => submitRsvp(input, party);

}

function updatePlusOneLabel(index, defaultLabel) {

  const input =
    document.getElementById(`plusone_name_${index}`);

  const label =
    document.getElementById(`attend_label_plusone_${index}`);

  const name = input.value.trim();

  label.textContent =
    name ? `Will ${name} attend?`
         : `Will ${defaultLabel} attend?`;

}

async function submitRsvp(code, party) {

  const status =
    document.getElementById("saveStatus");

  const btn =
    document.getElementById("submitBtn");

  const payload = {

    code: code,

    name: party.displayName,

    attending: "",

    dietary:
      document.getElementById("dietary").value.trim(),

    message:
      document.getElementById("message").value.trim()

  };

  const lines = [];

  (party.guests || []).forEach((guestName, idx) => {

    const val =
      document.getElementById(`attend_named_${idx}`).value;

    lines.push(`${guestName}: ${val}`);

  });

  const namedCount =
    (party.guests || []).length;

  const allowed =
    party.allowedGuests || namedCount;

  const extraSeats =
    Math.max(0, allowed - namedCount);

  for (let i = 1; i <= extraSeats; i++) {

    const plusName =
      document.getElementById(`plusone_name_${i}`).value.trim();

    const val =
      document.getElementById(`attend_plusone_${i}`).value;

    if (plusName)
      lines.push(`${plusName}: ${val}`);

  }

  payload.attending =
    lines.join(" | ");

  try {

    status.textContent = "Savingâ€¦";
    btn.disabled = true;

    const res =
      await fetch(
        "https://wedding-backend-fbbx.onrender.com/rsvp",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        }
      );

    const data = await res.json();

    if (!data.success)
      throw new Error();

    status.textContent =
      "Saved! Thank you ðŸŒ¿";

  }

  catch {

    status.textContent =
      "Could not save RSVP. Please try again.";

    btn.disabled = false;

  }

}
</script>



</body>
</html>
